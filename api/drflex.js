// api/drflex.js - CORRECT VERSION FOR GPT-3.5-TURBO export default async function handler(req, res) { res.setHeader("Content-Type", "application/json"); res.setHeader("Access-Control-Allow-Origin", "*"); res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS"); res.setHeader("Access-Control-Allow-Headers", "Content-Type, Accept"); if (req.method === "OPTIONS") return res.status(200).end(); if (req.method !== "POST") { return res.status(405).json({ error: "Method not allowed" }); } try { const { personality, history } = req.body; const OPENAI_API_KEY = process.env.OPENAI_API_KEY; if (!OPENAI_API_KEY) { return res.status(500).json({ error: "Missing API key" }); } // Build messages array for OpenAI const systemPrompt = personality || "You are Dr Flex, a motivational coach."; const messages = [ { role: "system", content: systemPrompt }, ...history.map(h => ({ role: h.role, content: h.content })) ]; console.log('üîµ Sending to OpenAI...'); // CORRECT OPENAI ENDPOINT! const aiResp = await fetch("https://api.openai.com/v1/chat/completions", { method: "POST", headers: { "Content-Type": "application/json", "Authorization": Bearer ${OPENAI_API_KEY} }, body: JSON.stringify({ model: "gpt-3.5-turbo", // GPT-3.5 as requested! messages: messages, max_tokens: 2000, temperature: 0.8 }) }); const data = await aiResp.json(); if (!aiResp.ok) { console.error('‚ùå OpenAI error:', data); return res.status(500).json({ error: "OpenAI error", details: data }); } // CORRECT RESPONSE FORMAT! const raw = data.choices[0]?.message?.content || ""; console.log('‚úÖ Got reply from OpenAI'); // Parse actions from <ACTION> blocks (not [ACTION:]) const actions = []; const actionRegex = /<ACTION>([\s\S]*?)<\/ACTION>/g; let match; while ((match = actionRegex.exec(raw)) !== null) { try { const actionData = JSON.parse(match[1].trim()); if (actionData.type && actionData.items && Array.isArray(actionData.items)) { actions.push(actionData); } } catch (e) { console.log('‚ö†Ô∏è Failed to parse action block:', e); } } // Remove action blocks from visible text const cleaned = raw.replace(/<ACTION>[\s\S]*?<\/ACTION>/g, '').trim(); console.log('üì§ Sending reply with', actions.length, 'actions'); return res.status(200).json({ reply: cleaned, actions: actions }); } catch (err) { console.error('üí• Server error:', err); return res.status(500).json({ error: "Server crashed", details: err.toString() }); } }
